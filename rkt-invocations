# With the converted Docker image pulled from Quay, we don't have named
# ports to map, so we 'net=host'. Similarly, the container's mount points
# aren't labeled, so we provide both the 'volume' the host is serving
# and the 'mount' target for it inside the container.
# However, caddy does know its working directory from the Dockerfile,
# so we don't mount a /Caddyfile -- dropping it in the volume that
# gets mounted at /var/www/html inside the container is sufficient.
sudo rkt run --net=host \
--volume html,kind=host,source=/home/core/jxsite/public,readOnly=true \
--mount volume=html,target=/var/www/html \
--volume dotcaddy,kind=host,source=/home/core/dotcaddy,readOnly=false \
--mount volume=dotcaddy,target=/root/.caddy \
--volume resolv,kind=host,source=/etc/resolv.conf,readOnly=true \
--mount volume=resolv,target=/etc/resolv.conf \
quay.io/josh_wood/caddy:latest

# Basic aci run - serve the included /var/www/html/index.html on host:32768
sudo rkt run --insecure-options=image --port http-alt:32768 \
caddy-v0.8.1-linux-amd64.aci

# The aci names three ports, so we can map only those and not give access to
# the entire host network namespace. Similarly, we can name just the 'volumes'
# the host supplies, because the mount points inside the container are
# enumerated in the aci manifest.
# EXCEPT the 'caddyfile' mount, which does not exist in container, but
# can be bound to /Caddyfile there, where caddy will read it because
# caddy's `cwd` is `/` in the container.
# EXCEPT the 'html' mount, which is not named in the aci, because the aci
# contains a default /var/www/html/index.html.
sudo rkt run --insecure-options=image \
--port http:80 --port https:443 --port http-alt:2015 \
--volume caddyfile,kind=host,source=$HOME/jxsite/Caddyfile,readOnly=true \
--mount volume=caddyfile,target=/Caddyfile \
--volume html,kind=host,source=$HOME/jxsite/public,readOnly=true \
--mount volume=html,target=/var/www/html \
--volume dotcaddy,kind=host,source=$HOME/dotcaddy,readOnly=false \
--volume resolv,kind=host,source=/etc/resolv.conf,readOnly=true \
caddy-v0.8.1-linux-amd64.aci
